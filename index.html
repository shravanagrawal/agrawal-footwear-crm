<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agrawal Footwear CRM + Inventory</title>

<!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- QRCode.js for generating QR codes -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  :root { --bg:#0f1220; --fg:#e8ecf1; --muted:#a8b0c2; --card:#171a2b; --accent:#5bd1ff; --danger:#ff6b6b; --ok:#79d88a; --border:#2a2f48; }
  * { box-sizing:border-box; }
  body { margin:0; font-family:Segoe UI, sans-serif; background:var(--bg); color:var(--fg); }
  header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--bg); z-index:10; }
  .brand { display:flex; align-items:center; gap:10px; }
  .brand h1 { font-size:16px; margin:0; font-weight:600; letter-spacing:0.3px; }
  nav a { color:var(--muted); margin:0 8px; text-decoration:none; }
  nav a.active { color:var(--accent); font-weight:600; }
  main { max-width:1100px; margin: 16px auto; padding: 0 16px; }
  .card { background:var(--card); border:1px solid var(--border); border-radius:10px; padding:16px; margin:12px 0; }
  input, select, button { background:#121528; border:1px solid var(--border); color:var(--fg); border-radius:8px; padding:10px; font-size:14px; }
  button.primary { background:linear-gradient(90deg,#5bd1ff,#7ef8d7); color:#04121a; border:none; font-weight:600; }
  button.ghost { background:transparent; border:1px solid var(--border); }
  table { width:100%; border-collapse:collapse; margin-top:8px; }
  th, td { border-bottom:1px solid #27304b; padding:10px; text-align:left; font-size:14px; }
  th { color:#9fb1c9; font-weight:600; }
  .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; color:#0c1a26; }
  .pill.ok { background:var(--ok); }
  .pill.warn { background:#ffcf6b; }
  .pill.bad { background:var(--danger); color:#fff; }
  footer { padding:16px; text-align:center; color:var(--muted); }
  .signature { margin-top:6px; font-style:italic; color:var(--accent); text-align:center; }
</style>
</head>
<body>
<header>
  <div class="brand">
    <!-- Inline Agrawal Footwear Logo -->
    <svg width="160" height="56" viewBox="0 0 400 120" xmlns="http://www.w3.org/2000/svg">
      <path d="M20 80 C60 20, 140 20, 200 80 Q220 100, 260 80 T380 80" fill="none" stroke="#5bd1ff" stroke-width="8" stroke-linecap="round"/>
      <line x1="20" y1="85" x2="380" y2="85" stroke="#79d88a" stroke-width="6" stroke-linecap="round"/>
      <text x="200" y="110" font-family="Segoe UI, sans-serif" font-size="28" text-anchor="middle" fill="#e8ecf1" font-weight="bold">Agrawal Footwear</text>
    </svg>
    <div>
      <h1>CRM + Inventory</h1>
      <div class="signature">Developed and managed By Shravan Agrawal</div>
    </div>
  </div>
  <nav id="nav"></nav>
</header>

<main id="app"></main>
<footer>
  Local-first. Offline-ready. IndexedDB storage. Single-file. Installable (PWA).
  <div class="signature">Developed and managed By Shravan Agrawal</div>
</footer>

<script>
/* =========================================================
   Agrawal Footwear â€” Serverless CRM + Inventory
   Includes: Login/Register, CRM, Inventory, Sales, PDF Invoice
   ========================================================= */

// ---------- Utilities ----------
const UI = {
  el(id){ return document.getElementById(id); },
  html(id, html){ document.getElementById(id).innerHTML = html; },
  notify(msg, type="ok"){
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<span class="pill ${type}">${type.toUpperCase()}</span> ${msg}`;
    document.querySelector("main").prepend(div);
    setTimeout(()=>div.remove(), 2500);
  },
  uid(){ return crypto.randomUUID(); },
  route(){ return location.hash.replace("#","")||"home"; }
};

// ---------- Auth ----------
const Auth = {
  tokenKey: "af_token",
  userKey: "af_user",
  roles: ["Admin","Manager","Sales","Warehouse","Accountant","ReadOnly"],
  current(){ const u = localStorage.getItem(this.userKey); return u ? JSON.parse(u) : null; },
  set(user){ localStorage.setItem(this.userKey, JSON.stringify(user)); localStorage.setItem(this.tokenKey, "token-"+UI.uid()); },
  clear(){ localStorage.removeItem(this.userKey); localStorage.removeItem(this.tokenKey); }
};

// ---------- IndexedDB ----------
const DB = {
  name: "af_crm_inventory_db",
  version: 1,
  db: null,
  async init(){
    if(this.db) return this.db;
    this.db = await new Promise((resolve, reject)=>{
      const req = indexedDB.open(this.name, this.version);
      req.onupgradeneeded = (e)=>{
        const db = e.target.result;
        db.createObjectStore("users", { keyPath: "id" });
        db.createObjectStore("accounts", { keyPath: "id" });
        db.createObjectStore("contacts", { keyPath: "id" });
        db.createObjectStore("products", { keyPath: "id" });
        db.createObjectStore("skus", { keyPath: "id" });
        db.createObjectStore("warehouses", { keyPath: "id" });
        db.createObjectStore("stock", { keyPath: "id" });
        db.createObjectStore("salesOrders", { keyPath: "id" });
        db.createObjectStore("salesOrderLines", { keyPath: "id" });
        db.createObjectStore("invoices", { keyPath: "id" });
      };
      req.onsuccess = ()=>resolve(req.result);
      req.onerror = ()=>reject(req.error);
    });
    return this.db;
  },
  async tx(storeNames, mode="readonly"){
    const db = await this.init();
    return db.transaction(storeNames, mode);
  },
  async put(store, obj){
    const tx = await this.tx([store], "readwrite");
    tx.objectStore(store).put(obj);
  },
  async add(store, obj){
    const tx = await this.tx([store], "readwrite");
    tx.objectStore(store).add(obj);
  },
  async all(store){
    const tx = await this.tx([store], "readonly");
    return new Promise(res=>{ tx.objectStore(store).getAll().onsuccess=e=>res(e.target.result||[]); });
  }
};

// ---------- Services ----------
const Svc = {
  async register({name,email,password,role}){
    const users = await DB.all("users");
    if(users.find(u=>u.email===email)) throw new Error("Email exists");
    const user = { id:UI.uid(), name, email, role, passwordHash:btoa(password) };
    await DB.add("users", user); return user
